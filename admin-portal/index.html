<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Portal - tiNi Wi-Fi Marketing</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header h1 { font-size: 1.5rem; }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid #ddd;
    }
    .tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    .card h2 {
      margin-bottom: 1rem;
      color: #1a202c;
    }
    .btn {
      padding: 0.5rem 1rem;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin: 0.25rem;
    }
    .btn:hover { background: #5568d3; }
    .btn-danger { background: #e53e3e; }
    .btn-danger:hover { background: #c53030; }
    .btn-success { background: #38a169; }
    .btn-success:hover { background: #2f855a; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f7fafc;
      font-weight: 600;
      color: #4a5568;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.25rem;
      color: #4a5568;
      font-weight: 500;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .form-group textarea {
      min-height: 80px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge-active { background: #c6f6d5; color: #22543d; }
    .badge-draft { background: #fed7d7; color: #742a2a; }
    .badge-paused { background: #feebc8; color: #7c2d12; }
    .badge-pending_approval { background: #bee3f8; color: #2c5282; }
    .badge-rejected { background: #fc8181; color: #742a2a; }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .close { font-size: 1.5rem; cursor: pointer; }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
    }
    .stat-label {
      color: #718096;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>tiNi Wi-Fi Marketing - Admin Portal</h1>
    <div style="margin-top: .5rem;">
      <label style="font-size:.9rem; opacity:.9;">Admin Token:</label>
      <input id="admin-token" type="password" style="padding:.35rem .5rem; border:1px solid #cbd5e0; border-radius:4px; width:280px;" placeholder="enter token (default: changeme-token)" />
      <button class="btn" onclick="saveToken()">Save</button>
      <span id="token-status" style="margin-left:.5rem; font-size:.9rem;"></span>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
      <button class="tab" onclick="showTab('campaigns')">Campaigns</button>
      <button class="tab" onclick="showTab('locations')">Locations</button>
      <button class="tab" onclick="showTab('brands')">Brands</button>
      <button class="tab" onclick="showTab('sessions')">Sessions</button>
      <button class="tab" onclick="showTab('surveys')">Surveys</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
      <div style="display:flex; justify-content:flex-end; margin-bottom:1rem;">
        <button class="btn" onclick="exportPDF()">Download PDF Report</button>
      </div>
      <div class="stats" id="dashboard-stats"></div>
      <div class="card">
        <h2>Recent Activity</h2>
        <p class="muted">Dashboard overview and KPI metrics</p>
      </div>
      <div class="card">
        <h2>Advanced Analytics & Monitoring</h2>
        <div style="margin-bottom:0.75rem;">
          <button class="btn" onclick="loadSegments()">Load Segments</button>
          <button class="btn" onclick="loadMonetization()">Monetization</button>
          <button class="btn" onclick="loadMonitoring()">Monitoring</button>
        </div>
        <pre id="segments-output" style="background:#f7fafc; padding:1rem; border-radius:8px; font-size:0.9rem; max-height:240px; overflow:auto;"></pre>
        <pre id="monetization-output" style="background:#f7fafc; padding:1rem; border-radius:8px; font-size:0.9rem; max-height:180px; overflow:auto; margin-top:0.75rem;"></pre>
        <pre id="monitoring-output" style="background:#f7fafc; padding:1rem; border-radius:8px; font-size:0.9rem; max-height:180px; overflow:auto; margin-top:0.75rem;"></pre>
      </div>
    </div>

    <!-- Campaigns Tab -->
    <div id="campaigns" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2>Campaigns</h2>
          <div>
            <button class="btn" onclick="exportCSV('campaigns')">Export CSV</button>
            <button class="btn" onclick="openCampaignModal()">+ New Campaign</button>
          </div>
        </div>
        <table id="campaigns-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Start</th>
              <th>End</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Locations Tab -->
    <div id="locations" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2>Locations</h2>
          <button class="btn" onclick="openLocationModal()">+ New Location</button>
        </div>
        <table id="locations-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Brand</th>
              <th>Address</th>
              <th>AP Identifier</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Brands Tab -->
    <div id="brands" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2>Brands</h2>
          <button class="btn" onclick="openBrandModal()">+ New Brand</button>
        </div>
        <table id="brands-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Sessions Tab -->
    <div id="sessions" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2>Sessions</h2>
          <button class="btn" onclick="exportCSV('sessions')">Export CSV</button>
        </div>
        <table id="sessions-table">
          <thead>
            <tr>
              <th>User ID</th>
              <th>Location</th>
              <th>Device</th>
              <th>Started</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Surveys Tab -->
    <div id="surveys" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2>Survey Responses</h2>
          <button class="btn" onclick="exportCSV('surveys')">Export CSV</button>
        </div>
        <table id="surveys-table">
          <thead>
            <tr>
              <th>User ID</th>
              <th>Answers</th>
              <th>Submitted</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Campaign Modal -->
  <div id="campaign-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="campaign-modal-title">New Campaign</h2>
        <span class="close" onclick="closeModal('campaign-modal')">&times;</span>
      </div>
      <form id="campaign-form">
        <input type="hidden" id="campaign-id" />
        <div class="form-group">
          <label>Brand</label>
          <select id="campaign-brand" required></select>
        </div>
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="campaign-name" required />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Status</label>
            <select id="campaign-status">
              <option value="draft">Draft</option>
              <option value="pending_approval">Pending Approval</option>
              <option value="active">Active</option>
              <option value="paused">Paused</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Start Time</label>
            <input type="datetime-local" id="campaign-start" />
          </div>
          <div class="form-group">
            <label>End Time</label>
            <input type="datetime-local" id="campaign-end" />
          </div>
        </div>
        <div class="form-group">
          <label>Targeting (JSON)</label>
          <textarea id="campaign-targeting" placeholder='{"locationIds": [], "deviceTypes": [], "firstTimeOnly": false}'></textarea>
        </div>
        <div class="form-group">
          <label>A/B Test Variants (JSON array)</label>
          <textarea id="campaign-ab-variants" placeholder='[{"name": "variant-a", "weight": 50, "content": "Version A"}, {"name": "variant-b", "weight": 50, "content": "Version B"}]'></textarea>
          <small style="color: #718096;">Leave empty for no A/B testing. Weight determines traffic distribution.</small>
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button type="button" class="btn" onclick="closeModal('campaign-modal')">Cancel</button>
          <button type="button" class="btn" onclick="submitForApproval()" id="submit-approval-btn" style="display: none;">Submit for Approval</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Location Modal -->
  <div id="location-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="location-modal-title">New Location</h2>
        <span class="close" onclick="closeModal('location-modal')">&times;</span>
      </div>
      <form id="location-form">
        <input type="hidden" id="location-id" />
        <div class="form-group">
          <label>Brand</label>
          <select id="location-brand" required></select>
        </div>
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="location-name" required />
        </div>
        <div class="form-group">
          <label>Address</label>
          <input type="text" id="location-address" />
        </div>
        <div class="form-group">
          <label>AP Identifier</label>
          <input type="text" id="location-ap" />
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button type="button" class="btn" onclick="closeModal('location-modal')">Cancel</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Brand Modal -->
  <div id="brand-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>New Brand</h2>
        <span class="close" onclick="closeModal('brand-modal')">&times;</span>
      </div>
      <form id="brand-form">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="brand-name" required />
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button type="button" class="btn" onclick="closeModal('brand-modal')">Cancel</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    const TRACKING_BASE = '/tracking';
    let ADMIN_TOKEN = localStorage.getItem('tini_admin_token') || '';
    document.addEventListener('DOMContentLoaded', () => {
      const field = document.getElementById('admin-token');
      if (ADMIN_TOKEN) field.value = ADMIN_TOKEN;
      updateTokenStatus();
    });
    function saveToken() {
      ADMIN_TOKEN = document.getElementById('admin-token').value.trim();
      localStorage.setItem('tini_admin_token', ADMIN_TOKEN);
      updateTokenStatus();
    }
    function updateTokenStatus() {
      const el = document.getElementById('token-status');
      el.textContent = ADMIN_TOKEN ? 'Token set' : 'No token';
      el.style.color = ADMIN_TOKEN ? '#38a169' : '#e53e3e';
    }
    function authHeaders() {
      const h = { 'Content-Type': 'application/json' };
      if (ADMIN_TOKEN) h['X-Admin-Token'] = ADMIN_TOKEN;
      return h;
    }

    // Tab switching
    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      if (tabName === 'dashboard') loadDashboard();
      else if (tabName === 'campaigns') loadCampaigns();
      else if (tabName === 'locations') loadLocations();
      else if (tabName === 'brands') loadBrands();
      else if (tabName === 'sessions') loadSessions();
      else if (tabName === 'surveys') loadSurveys();
    }

    // Dashboard
    async function loadDashboard() {
      try {
        const kpi = await fetch(`${TRACKING_BASE}/kpi`).then(r => r.json());
        const statsHtml = `
          <div class="stat-card">
            <div class="stat-value">${kpi.totals.impressions}</div>
            <div class="stat-label">Total Impressions</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${kpi.totals.clicks}</div>
            <div class="stat-label">Total Clicks</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${kpi.totals.sessions}</div>
            <div class="stat-label">Total Sessions</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${kpi.today.impressions}</div>
            <div class="stat-label">Today Impressions</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${kpi.today.clicks}</div>
            <div class="stat-label">Today Clicks</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${kpi.today.sessions}</div>
            <div class="stat-label">Today Sessions</div>
          </div>
        `;
        document.getElementById('dashboard-stats').innerHTML = statsHtml;
      } catch (e) {
        console.error('Failed to load dashboard:', e);
      }
    }

    // Campaigns
    async function loadCampaigns() {
      try {
        const campaigns = await fetch(`${API_BASE}/campaigns`).then(r => r.json());
        const tbody = document.querySelector('#campaigns-table tbody');
        tbody.innerHTML = campaigns.map(c => `
          <tr>
            <td>${escapeHtml(c.name)}</td>
            <td><span class="badge badge-${c.status}">${c.status}</span></td>
            <td>${c.start_time ? new Date(c.start_time).toLocaleString() : '-'}</td>
            <td>${c.end_time ? new Date(c.end_time).toLocaleString() : '-'}</td>
            <td>
              <button class="btn" onclick="editCampaign('${c.id}')">Edit</button>
              ${c.status === 'draft' ? `<button class="btn" onclick="submitForApproval('${c.id}')">Submit</button>` : ''}
              ${c.status === 'pending_approval' ? `<button class="btn btn-success" onclick="approveCampaign('${c.id}')">Approve</button><button class="btn btn-danger" onclick="rejectCampaign('${c.id}')">Reject</button>` : ''}
              <button class="btn btn-danger" onclick="deleteCampaign('${c.id}')">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Failed to load campaigns:', e);
      }
    }

    async function openCampaignModal(id = null) {
      await loadBrandsForSelect('campaign-brand');
      if (id) {
        const campaign = await fetch(`${API_BASE}/campaign/${id}`).then(r => r.json());
        document.getElementById('campaign-id').value = campaign.id;
        document.getElementById('campaign-name').value = campaign.name;
        document.getElementById('campaign-status').value = campaign.status;
        document.getElementById('campaign-brand').value = campaign.brand_id;
        document.getElementById('campaign-start').value = campaign.start_time ? new Date(campaign.start_time).toISOString().slice(0, 16) : '';
        document.getElementById('campaign-end').value = campaign.end_time ? new Date(campaign.end_time).toISOString().slice(0, 16) : '';
        document.getElementById('campaign-targeting').value = JSON.stringify(campaign.targeting || {}, null, 2);
        document.getElementById('campaign-ab-variants').value = JSON.stringify(campaign.ab_test_variants || [], null, 2);
        document.getElementById('submit-approval-btn').style.display = campaign.status === 'draft' ? 'inline-block' : 'none';
        document.getElementById('campaign-modal-title').textContent = 'Edit Campaign';
      } else {
        document.getElementById('campaign-form').reset();
        document.getElementById('campaign-id').value = '';
        document.getElementById('campaign-ab-variants').value = '';
        document.getElementById('submit-approval-btn').style.display = 'none';
        document.getElementById('campaign-modal-title').textContent = 'New Campaign';
      }
      document.getElementById('campaign-modal').classList.add('active');
    }

    async function editCampaign(id) {
      await openCampaignModal(id);
    }

    document.getElementById('campaign-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('campaign-id').value;
      const data = {
        brandId: document.getElementById('campaign-brand').value,
        name: document.getElementById('campaign-name').value,
        status: document.getElementById('campaign-status').value,
        startTime: document.getElementById('campaign-start').value || null,
        endTime: document.getElementById('campaign-end').value || null,
        targeting: JSON.parse(document.getElementById('campaign-targeting').value || '{}'),
        abTestVariants: JSON.parse(document.getElementById('campaign-ab-variants').value || '[]')
      };
      try {
        if (id) {
          await fetch(`${API_BASE}/campaign/${id}`, {
            method: 'PUT',
            headers: authHeaders(),
            body: JSON.stringify(data)
          });
        } else {
          await fetch(`${API_BASE}/campaign`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify(data)
          });
        }
        closeModal('campaign-modal');
        loadCampaigns();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    async function deleteCampaign(id) {
      if (!confirm('Delete this campaign?')) return;
      try {
        await fetch(`${API_BASE}/campaign/${id}`, { method: 'DELETE', headers: authHeaders() });
        loadCampaigns();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function submitForApproval(id) {
      if (!id) {
        // Submit from modal
        const campaignId = document.getElementById('campaign-id').value;
        if (!campaignId) {
          alert('Please save the campaign first');
          return;
        }
        id = campaignId;
      }
      try {
        await fetch(`${API_BASE}/campaigns/${id}/submit`, { method: 'POST', headers: authHeaders() });
        closeModal('campaign-modal');
        loadCampaigns();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function approveCampaign(id) {
      if (!confirm('Approve this campaign?')) return;
      try {
        await fetch(`${API_BASE}/campaigns/${id}/approve`, { method: 'POST', headers: authHeaders() });
        loadCampaigns();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function rejectCampaign(id) {
      if (!confirm('Reject this campaign?')) return;
      try {
        await fetch(`${API_BASE}/campaigns/${id}/reject`, { method: 'POST', headers: authHeaders() });
        loadCampaigns();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Locations
    async function loadLocations() {
      try {
        const locations = await fetch(`${API_BASE}/locations`).then(r => r.json());
        const tbody = document.querySelector('#locations-table tbody');
        tbody.innerHTML = locations.map(l => `
          <tr>
            <td>${escapeHtml(l.name)}</td>
            <td>${escapeHtml(l.brand_name || '')}</td>
            <td>${escapeHtml(l.address || '')}</td>
            <td>${escapeHtml(l.ap_identifier || '')}</td>
            <td>
              <button class="btn" onclick="editLocation('${l.id}')">Edit</button>
              <button class="btn btn-danger" onclick="deleteLocation('${l.id}')">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Failed to load locations:', e);
      }
    }

    async function openLocationModal(id = null) {
      await loadBrandsForSelect('location-brand');
      if (id) {
        const location = await fetch(`${API_BASE}/locations`).then(r => r.json()).then(locs => locs.find(l => l.id === id));
        if (location) {
          document.getElementById('location-id').value = location.id;
          document.getElementById('location-name').value = location.name;
          document.getElementById('location-brand').value = location.brand_id;
          document.getElementById('location-address').value = location.address || '';
          document.getElementById('location-ap').value = location.ap_identifier || '';
          document.getElementById('location-modal-title').textContent = 'Edit Location';
        }
      } else {
        document.getElementById('location-form').reset();
        document.getElementById('location-id').value = '';
        document.getElementById('location-modal-title').textContent = 'New Location';
      }
      document.getElementById('location-modal').classList.add('active');
    }

    async function editLocation(id) {
      await openLocationModal(id);
    }

    document.getElementById('location-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('location-id').value;
      const data = {
        brandId: document.getElementById('location-brand').value,
        name: document.getElementById('location-name').value,
        address: document.getElementById('location-address').value,
        apIdentifier: document.getElementById('location-ap').value
      };
      try {
        if (id) {
          await fetch(`${API_BASE}/locations/${id}`, {
            method: 'PUT',
            headers: authHeaders(),
            body: JSON.stringify(data)
          });
        } else {
          await fetch(`${API_BASE}/locations`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify(data)
          });
        }
        closeModal('location-modal');
        loadLocations();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    async function deleteLocation(id) {
      if (!confirm('Delete this location?')) return;
      try {
        await fetch(`${API_BASE}/locations/${id}`, { method: 'DELETE', headers: authHeaders() });
        loadLocations();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Brands
    async function loadBrands() {
      try {
        const brands = await fetch(`${API_BASE}/brands`).then(r => r.json());
        const tbody = document.querySelector('#brands-table tbody');
        tbody.innerHTML = brands.map(b => `
          <tr>
            <td>${escapeHtml(b.name)}</td>
            <td>${new Date(b.created_at).toLocaleDateString()}</td>
            <td>
              <button class="btn btn-danger" onclick="deleteBrand('${b.id}')">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Failed to load brands:', e);
      }
    }

    async function loadBrandsForSelect(selectId) {
      try {
        const brands = await fetch(`${API_BASE}/brands`).then(r => r.json());
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Select Brand</option>' + brands.map(b => 
          `<option value="${b.id}">${escapeHtml(b.name)}</option>`
        ).join('');
      } catch (e) {
        console.error('Failed to load brands:', e);
      }
    }

    async function openBrandModal() {
      document.getElementById('brand-form').reset();
      document.getElementById('brand-modal').classList.add('active');
    }

    document.getElementById('brand-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = { name: document.getElementById('brand-name').value };
      try {
        await fetch(`${API_BASE}/brands`, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify(data)
        });
        closeModal('brand-modal');
        loadBrands();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    async function deleteBrand(id) {
      if (!confirm('Delete this brand?')) return;
      try {
        await fetch(`${API_BASE}/brands/${id}`, { method: 'DELETE', headers: authHeaders() });
        loadBrands();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Sessions
    async function loadSessions() {
      try {
        const sessions = await fetch(`${TRACKING_BASE}/analytics/sessions?limit=50`).then(r => r.json());
        const tbody = document.querySelector('#sessions-table tbody');
        tbody.innerHTML = sessions.map(s => `
          <tr>
            <td>${escapeHtml(s.anon_id || '')}</td>
            <td>${escapeHtml(s.location_name || '')}</td>
            <td>${escapeHtml(s.device_type || '')}</td>
            <td>${new Date(s.started_at).toLocaleString()}</td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Failed to load sessions:', e);
      }
    }

    // Surveys
    async function loadSurveys() {
      try {
        const surveys = await fetch(`${TRACKING_BASE}/analytics/surveys`).then(r => r.json());
        const tbody = document.querySelector('#surveys-table tbody');
        tbody.innerHTML = surveys.map(s => `
          <tr>
            <td>${escapeHtml(s.anon_id || '')}</td>
            <td><pre style="font-size: 0.8rem;">${JSON.stringify(s.answers, null, 2)}</pre></td>
            <td>${new Date(s.submitted_at).toLocaleString()}</td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Failed to load surveys:', e);
      }
    }

    // Advanced analytics & monitoring
    async function loadSegments() {
      try {
        const data = await fetch('/api/analytics/segments').then(r => r.json());
        document.getElementById('segments-output').textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        document.getElementById('segments-output').textContent = 'Error: ' + e.message;
      }
    }

    async function loadMonetization() {
      try {
        const data = await fetch('/api/monetization/summary').then(r => r.json());
        document.getElementById('monetization-output').textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        document.getElementById('monetization-output').textContent = 'Error: ' + e.message;
      }
    }

    async function loadMonitoring() {
      try {
        const data = await fetch('/api/monitoring/status').then(r => r.json());
        document.getElementById('monitoring-output').textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        document.getElementById('monitoring-output').textContent = 'Error: ' + e.message;
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Export CSV/PDF
    function exportCSV(type) {
      const url = `${TRACKING_BASE}/export/${type}.csv`;
      window.open(url, '_blank');
    }
    function exportPDF() {
      const url = `${TRACKING_BASE}/export/report.pdf`;
      window.open(url, '_blank');
    }

    // Initialize
    loadDashboard();
  </script>
</body>
</html>
