<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      body { font-family: Arial, sans-serif; margin: 2rem; }
      .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
      .card { padding: 1rem; border: 1px solid #eee; border-radius: 8px; }
      #heatmap-map { height: 300px; width: 100%; border-radius: 4px; margin-top: 0.5rem; }
    </style>
  </head>
  <body>
    <h1>Analytics Dashboard</h1>
    <div class="grid">
      <div class="card">
        <h3>Totals</h3>
        <p>Impressions: <strong id="t-impr">-</strong></p>
        <p>Clicks: <strong id="t-clicks">-</strong></p>
        <p>Sessions: <strong id="t-sessions">-</strong></p>
      </div>
      <div class="card">
        <h3>Today</h3>
        <p>Impressions: <strong id="d-impr">-</strong></p>
        <p>Clicks: <strong id="d-clicks">-</strong></p>
        <p>Sessions: <strong id="d-sessions">-</strong></p>
      </div>
      <div class="card">
        <h3>Alerts</h3>
        <div id="alerts-list" style="max-height:260px; overflow:auto;"></div>
      </div>
      <div class="card" style="grid-column: 1 / -1;">
        <h3>Heatmap (Today)</h3>
        <div id="heatmap-map"></div>
        <div id="heatmap-list" style="max-height:200px; overflow:auto; margin-top: 1rem;"></div>
      </div>
      <div class="card">Reports Placeholder</div>
    </div>
    <script>
      async function loadKpi(){
        try {
          const base = window.location.protocol + '//' + window.location.hostname + ':3001';
          const res = await fetch(base + '/kpi');
          const k = await res.json();
          document.getElementById('t-impr').textContent = k.totals.impressions;
          document.getElementById('t-clicks').textContent = k.totals.clicks;
          document.getElementById('t-sessions').textContent = k.totals.sessions;
          document.getElementById('d-impr').textContent = k.today.impressions;
          document.getElementById('d-clicks').textContent = k.today.clicks;
          document.getElementById('d-sessions').textContent = k.today.sessions;
        } catch(e) { console.error(e); }
      }
      let heatmapMap = null;
      async function loadHeatmap(){
        try {
          const base = window.location.protocol + '//' + window.location.hostname + ':3001';
          const res = await fetch(base + '/analytics/heatmap');
          const rows = await res.json();
          const el = document.getElementById('heatmap-list');
          if (!rows.length) { 
            el.innerHTML = '<p class="muted">No coordinates configured.</p>';
            if (heatmapMap) heatmapMap.remove();
            return; 
          }
          
          // Update list
          el.innerHTML = rows.map(r => `
            <div style="display:flex; justify-content:space-between; padding:.35rem 0; border-bottom:1px solid #eee;">
              <div>
                <div><strong>${escapeHtml(r.name)}</strong></div>
                <div class="muted" style="font-size:.85rem;">(${r.latitude?.toFixed(5)}, ${r.longitude?.toFixed(5)})</div>
              </div>
              <div><strong>${r.sessions_today}</strong> sessions</div>
            </div>
          `).join('');

          // Update map
          if (!heatmapMap) {
            const avgLat = rows.reduce((sum, r) => sum + (r.latitude || 0), 0) / rows.length;
            const avgLng = rows.reduce((sum, r) => sum + (r.longitude || 0), 0) / rows.length;
            heatmapMap = L.map('heatmap-map').setView([avgLat || 10.8231, avgLng || 106.6297], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '© OpenStreetMap contributors'
            }).addTo(heatmapMap);
          }
          
          heatmapMap.eachLayer(layer => {
            if (layer instanceof L.Marker) heatmapMap.removeLayer(layer);
          });

          const maxSessions = Math.max(...rows.map(r => r.sessions_today || 0), 1);
          rows.forEach(r => {
            if (r.latitude && r.longitude) {
              const radius = Math.max(10, (r.sessions_today || 0) / maxSessions * 30);
              const color = r.sessions_today > maxSessions * 0.7 ? '#e53e3e' : r.sessions_today > maxSessions * 0.3 ? '#d69e2e' : '#38a169';
              L.circleMarker([r.latitude, r.longitude], {
                radius: radius,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.7
              }).bindPopup(`<strong>${escapeHtml(r.name)}</strong><br>${r.sessions_today} sessions today`).addTo(heatmapMap);
            }
          });
        } catch(e) { console.error(e); }
      }
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      async function loadAlerts(){
        try {
          const base = window.location.protocol + '//' + window.location.hostname + ':3001';
          const res = await fetch(base + '/alerts');
          const data = await res.json();
          const el = document.getElementById('alerts-list');
          if (!data.alerts || !data.alerts.length) {
            el.innerHTML = '<p class="muted">No alerts</p>';
            return;
          }
          el.innerHTML = data.alerts.map(a => `
            <div style="border-left:4px solid ${a.severity === 'critical' ? '#e53e3e' : '#d69e2e'}; padding:.35rem .5rem; margin:.35rem 0; background:#fdf2f8;">
              <div style="font-weight:600;">${a.severity.toUpperCase()} – ${a.type}</div>
              <div>${escapeHtml(a.message)}</div>
            </div>
          `).join('');
        } catch(e) { console.error(e); }
      }
      loadKpi();
      loadHeatmap();
      loadAlerts();
      setInterval(loadKpi, 10000);
      setInterval(loadHeatmap, 15000);
      setInterval(loadAlerts, 12000);
    </script>
  </body>
  </html>


